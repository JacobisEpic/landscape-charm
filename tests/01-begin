#!/usr/bin/python2.7
"""
This test simply creates a real landscape deployment, and runs a command there.
There isn't much to it for now.  The intent is to deploy landscape and our
dependent charms to test for any non-starter type issues.
"""
#TODO:
# - amulet bug: juju-deployer include directives don't take path into
#               consideration
# - amulet bug: couldn't get sentries to work... need to retry
# - amulet bug: juju environment is assumed from the data file.
# - amulet bug: proper juju deployer files are assembled from multiple
#               stanzas, amulet doesn't appear to support this.
# - amulet bug: it chokes if the config file doesn't contain all stanzas


import subprocess
import shutil
import logging
import amulet
import os
PATH = os.path.dirname(os.path.realpath(__file__))


def test(config):
    print("Testing Basic Deployment of the Landscape Charm Stack")
    logging.basicConfig(
        level='DEBUG', format='%(asctime)s %(levelname)s %(message)s')
    shutil.copy2("config/vhostssl.tmpl", ".")
    shutil.copy2("config/vhost.tmpl", ".")
    shutil.copy2("config/repo-file", ".")
    shutil.copy2("config/license-file", ".")

    d = amulet.Deployment(sentries=False)
    d.load(config)

    d.setup(timeout=2000)

    print(subprocess.check_output(["juju", "ssh", "landscape/0", "free -m"]))

config = subprocess.check_output(
    "util/fix-config ../config/landscape-deployments.cfg",
    shell=True, cwd=PATH)
print "PATH: %s" % PATH
print "config: %s" % config
test(config)
