{%- set postgres = db[0] -%}
{%- set rabbitmq = amqp[0] -%}
[global]
# Syslog address is either a socket path or server:port string.
syslog-address = /dev/log
deployment-mode = {{ hosted[0]["deployment-mode"] }}
{% if config["root-url"] -%}
root-url = {{ config["root-url"] }}
{%- else -%}
root-url = https://{{ website[0]["public-address"] }}/
{%- endif %}

[stores]
host = {{ postgres["host"] }}:{{ postgres["port"] }}
user = landscape
password = {{ leader["database-password"] }}
main = landscape-main
account-1 = landscape-account-1
resource-1 = landscape-resource-1
package = landscape-package
session = landscape-session
session-autocommit = landscape-session?isolation=autocommit
knowledge = landscape-knowledge

[broker]
port = 5672
host = {{ rabbitmq["hostname"] }}
user = landscape
password = {{ rabbitmq["password"] }}
vhost = landscape

[schema]
threads = 1
stores = main account-1 resource-1 package session knowledge
store_user = {{ postgres["user"] }}
store_password = {{ postgres["password"] }}

[landscape]
base-port = 8080
threads = 8
stores = main account-1 resource-1 package session session-autocommit knowledge
mailer = queue
mailer-path = /var/lib/landscape/landscape-mail-queue
reprepro-binary = /opt/canonical/landscape/scripts/reprepro-wrapper.sh
repository-path = /var/lib/landscape/landscape-repository
secret-token = {{ leader["secret-token"] }}
{% if config["openid-provider-url"] and config["openid-logout-url"] -%}
openid-provider-url = {{ config["openid-provider-url"] }}
openid-logout-url = {{ config["openid-logout-url"] }}
{%- endif %}
strict-transport-security = true

[api]
stores = main account-1 resource-1 package
threads = 10
base-port = 9080
mailer = queue
mailer-path = /var/lib/landscape/landscape-mail-queue
{% if config["root-url"] -%}
root-url = {{ config["root-url"] }}
{%- else -%}
root-url = https://{{ website[0]["public-address"] }}/
{%- endif %}

[message-server]
base-port = 8090
threads = 8
stores = main account-1 resource-1 package

[pingserver]
base-port = 8070
stores = main account-1 resource-1
threads = 2

[async-frontend]
base-port = 9090

[job-handler]
stores = main account-1 resource-1 package
threads = 10
mailer = queue
mailer-path = /var/lib/landscape/landscape-mail-queue

[load-shaper]
critical-load = 10.0
good-load = 3.0
good-duration = 60.0

[scripts]
threads = 1
stores = main account-1 resource-1 package session knowledge
mailer = queue
mailer-path = /var/lib/landscape/landscape-mail-queue

[package-search]
{% if is_leader -%}
host = localhost
{%- else -%}
host = {{ leader["leader-ip"] }}
{%- endif %}
port = 9099
stores = main package resource-1
pid-path = /var/run/landscape/landscape-package-search.pid
account-threshold = 0

[package-upload]
stores = main account-1
threads = 2
port = 9100
{% if config["root-url"] -%}
root-url = {{ config["root-url"] }}
{%- else -%}
root-url = https://{{ website[0]["public-address"] }}/
{%- endif %}

[maintenance]
threads = 1
stores = main account-1 resource-1 package session session-autocommit knowledge
mailer = queue
mailer-path = /var/lib/landscape/landscape-mail-queue

{% if hosted[0]["ppas-to-proxy"] -%}
[pppa-proxy]
base-port = 9298
stores = main
{% if hosted[0]["supported-releases"] -%}
supported-releases = {{ " ".join(hosted[0]["supported-releases"]) }}
{%- endif %}
{% for name, url in hosted[0]["ppas-to-proxy"].iteritems() %}
{{ name }}-url = {{ url }}
{% endfor %}
{%- endif %}
