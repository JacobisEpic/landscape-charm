#!/bin/bash -xe

ROOT="$( cd "$( dirname "$0" )" && pwd )"

LS_LICENSE_FILE=`config-get license-file`
LICENSE_FILE_DEST=/etc/landscape/license.txt
LICENSE_FILE_RE='^`(.*)`$'
PUBLIC=`unit-get public-address`
SERVICES=$(config-get services)

# Provides $DEFAULT_VAR map
source $ROOT/services.sh

# For now, this will just enable http
setup_apache() {
    a2enmod rewrite
    a2enmod proxy_http
    a2enmod ssl
    a2enmod headers
    a2enmod expires
    a2dissite default
    cp $ROOT/conf/landscape-http /etc/apache2/sites-available/landscape
    sed -e "s/@hostname@/$PUBLIC/" -i /etc/apache2/sites-available/landscape
    a2ensite landscape
    service apache2 restart
}

# Save the services in /etc/landscape/services so that if someone runs
# juju set it will be ignored in the landscape-relation-part
enable_services() {
    juju-log "Selected services: $SERVICES"
    echo $SERVICES > /etc/landscape/services
    for i in $SERVICES; do
        juju-log "Enabling: $i"
        if [ $i == "static" ]; then
            setup_apache
        else
            var=${DEFAULT_VAR[$i]}
            sed -i "s/${var}=.*/${var}=\"yes\"/g" /etc/default/landscape-server
        fi
    done
}

install_license() {
    [ -z "$LS_LICENSE_FILE" ] && return
    echo "$LS_LICENSE_FILE" > /var/tmp/ls-license-file.1
    if [ -f /var/tmp/ls-license-file ]; then
        if diff /var/tmp/ls-license-file /var/tmp/ls-license-file.1; then
            return
        fi
    fi

    # Save for comparison next time
    echo "$LS_LICENSE_FILE" > /var/tmp/ls-license-file

    if [[ $LS_LICENSE_FILE =~ $LICENSE_FILE_RE ]]; then
        LS_LICENSE_FILE=$(${BASH_REMATCH[1]})
    fi
    echo "$LS_LICENSE_FILE" > $LICENSE_FILE_DEST
    lsctl restart || /bin/true
}

# Put the license file in place.
install_license

# Enable all services that the were requested in the config
enable_services

exit 0
